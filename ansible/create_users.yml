---
- name: Strict per-user SSH access per port
  hosts: all
  become: true
  vars:
    user_ports:
      - { name: "alice", port: 2221 }
      - { name: "bob", port: 2222 }
      - { name: "charlie", port: 2223 }
      - { name: "shubham", port: 2224 }

  tasks:

    - name: ğŸ”’ Stop and disable default SSH (port 22)
      systemd:
        name: ssh
        enabled: no
        state: stopped

    - name: âœ… Ensure /run/sshd exists (needed for custom sshd)
      file:
        path: /run/sshd
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: ğŸ‘¤ Create users
      user:
        name: "{{ item.name }}"
        state: present
        shell: /bin/bash
        create_home: yes
      loop: "{{ user_ports }}"

    - name: ğŸ“ Create .ssh directory
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ user_ports }}"

    - name: ğŸ”‘ Add public key to authorized_keys
      copy:
        src: keys/shared.pub
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
        remote_src: no
      loop: "{{ user_ports }}"

    - name: ğŸ“„ Copy base sshd_config for each user port
      copy:
        src: /etc/ssh/sshd_config
        dest: "/etc/ssh/sshd_config_{{ item.port }}"
        remote_src: yes
      loop: "{{ user_ports }}"

    - name: âš™ï¸ Set custom Port in sshd_config
      lineinfile:
        path: "/etc/ssh/sshd_config_{{ item.port }}"
        regexp: '^Port '
        line: "Port {{ item.port }}"
      loop: "{{ user_ports }}"

    - name: ğŸš« Restrict login to single user per port
      lineinfile:
        path: "/etc/ssh/sshd_config_{{ item.port }}"
        regexp: '^AllowUsers '
        line: "AllowUsers {{ item.name }}"
        insertafter: EOF
      loop: "{{ user_ports }}"

    - name: ğŸ”’ Disable root login
      lineinfile:
        path: "/etc/ssh/sshd_config_{{ item.port }}"
        regexp: '^PermitRootLogin '
        line: "PermitRootLogin no"
      loop: "{{ user_ports }}"

    - name: ğŸ” Disable password authentication
      lineinfile:
        path: "/etc/ssh/sshd_config_{{ item.port }}"
        regexp: '^PasswordAuthentication '
        line: "PasswordAuthentication no"
      loop: "{{ user_ports }}"

    - name: ğŸš€ Start sshd for each custom port
      shell: |
        /usr/sbin/sshd -f /etc/ssh/sshd_config_{{ item.port }}
      loop: "{{ user_ports }}"
