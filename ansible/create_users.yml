---
- name: Per-user exclusive SSH ports (systemd-managed, validated)
  hosts: all
  become: true

  vars:
    user_ports:
      - { name: "alice",   port: 2221 }
      - { name: "bob",     port: 2222 }
      - { name: "charlie", port: 2223 }
      - { name: "shubham", port: 2224 }

    shared_pubkey_src: "keys/shared.pub"  # on controller
    disable_port_22: true                 # stop default ssh after all good

  tasks:
    - name: Ensure OpenSSH server is installed
      apt:
        name: openssh-server
        state: present
        update_cache: yes

    - name: Ensure privsep dir exists
      file:
        path: /run/sshd
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Ensure users exist
      user:
        name: "{{ item.name }}"
        state: present
        shell: /bin/bash
        create_home: yes
      loop: "{{ user_ports }}"

    - name: Create ~/.ssh for each user
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        mode: "0700"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ user_ports }}"

    - name: Install shared authorized_keys for each user
      copy:
        src: "{{ shared_pubkey_src }}"
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: "0600"
        remote_src: no
      loop: "{{ user_ports }}"

    - name: Write minimal per-port sshd configs (only allow mapped user)
      copy:
        dest: "/etc/ssh/sshd_config_{{ item.port }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          # Isolated sshd for port {{ item.port }}
          Port {{ item.port }}
          ListenAddress 0.0.0.0
          Protocol 2
          AddressFamily any
          PidFile /run/sshd/sshd-{{ item.port }}.pid

          PermitRootLogin no
          PasswordAuthentication no
          PubkeyAuthentication yes
          AuthorizedKeysFile .ssh/authorized_keys
          ChallengeResponseAuthentication no
          UsePAM yes
          X11Forwarding no
          PrintMotd no
          ClientAliveInterval 300
          ClientAliveCountMax 2

          # Restrict to single user for this port
          AllowUsers {{ item.name }}

          # Load distro defaults last (safe)
          Include /etc/ssh/sshd_config.d/*.conf
      loop: "{{ user_ports }}"

    - name: Ensure SSH host keys exist
      command: ssh-keygen -A
      changed_when: false

    - name: Validate per-port sshd configs
      command: "sshd -t -f /etc/ssh/sshd_config_{{ item.port }}"
      loop: "{{ user_ports }}"
      changed_when: false

    - name: Install systemd template for per-port sshd
      copy:
        dest: /etc/systemd/system/sshd@.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=OpenSSH per-port instance %i
          After=network.target
          Wants=network.target

          [Service]
          Type=forking
          PIDFile=/run/sshd/sshd-%i.pid
          ExecStartPre=/usr/sbin/sshd -t -f /etc/ssh/sshd_config_%i
          ExecStart=/usr/sbin/sshd -f /etc/ssh/sshd_config_%i
          ExecReload=/bin/kill -HUP $MAINPID
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable & start per-port sshd instances
      systemd:
        name: "sshd@{{ item.port }}"
        state: started
        enabled: yes
      loop: "{{ user_ports }}"
      register: start_results
      ignore_errors: true

    - name: Show failing units (if any)
      debug:
        msg: "Port {{ item.item.port }} failed to start: {{ item.msg | default('') }}"
      when: item is failed
      loop: "{{ start_results.results }}"

    - name: Fetch journal for failing units
      command: "journalctl -xeu sshd@{{ item.item.port }} --no-pager | tail -n 120"
      when: item is failed
      loop: "{{ start_results.results }}"
      register: journals
      changed_when: false

    - name: Print journal snippets
      debug:
        var: journals.results | map(attribute='stdout') | list
      when: journals is defined and (journals.results | length) > 0

    - name: Fail if any sshd instances failed
      assert:
        that:
          - (start_results.results | select('failed') | list | length) == 0
        fail_msg: "One or more sshd@PORT instances failed to start. See logs above."
        success_msg: "All sshd@PORT instances started successfully."

    # Optional: allow ports in UFW if present; ignore if ufw absent
    - name: Allow ports in UFW if available
      command: "ufw allow {{ item.port }}/tcp"
      loop: "{{ user_ports }}"
      register: ufw_result
      changed_when: "'Skipping' not in (ufw_result.stdout | default(''))"
      failed_when: false

    - name: Show listening sshd sockets
      command: bash -lc "ss -tulpn | grep -E ':(2221|2222|2223|2224)\\s' || true"
      register: ss_out
      changed_when: false

    - debug:
        var: ss_out.stdout

    # Stop default ssh only AFTER custom instances are up
    - name: Stop & disable default sshd on 22
      systemd:
        name: ssh
        state: stopped
        enabled: no
      when: disable_port_22
