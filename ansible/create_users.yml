---
- name: Enforce strict per-user SSH access per port
  hosts: all
  become: true
  vars:
    user_ports:
      - { name: "alice", port: 2221 }
      - { name: "bob", port: 2222 }
      - { name: "charlie", port: 2223 }
      - { name: "shubham", port: 2224 }

  tasks:

    - name: Stop default SSH on port 22
      systemd:
        name: ssh
        enabled: no
        state: stopped

    - name: Create user accounts
      user:
        name: "{{ item.name }}"
        shell: /bin/bash
        create_home: yes
        state: present
      loop: "{{ user_ports }}"

    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
      loop: "{{ user_ports }}"

    - name: Add shared public key
      copy:
        src: keys/shared.pub
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
        remote_src: no
      loop: "{{ user_ports }}"

    - name: Create custom sshd_config for each user/port
      blockinfile:
        path: "/etc/ssh/sshd_config_{{ item.port }}"
        create: yes
        block: |
          Port {{ item.port }}
          ListenAddress 0.0.0.0
          Protocol 2
          PermitRootLogin no
          PasswordAuthentication no
          AllowUsers {{ item.name }}
          AuthorizedKeysFile .ssh/authorized_keys
          ChallengeResponseAuthentication no
          UsePAM yes
          X11Forwarding no
          PrintMotd no
          ClientAliveInterval 300
          ClientAliveCountMax 2
          Subsystem sftp /usr/lib/openssh/sftp-server
      loop: "{{ user_ports }}"

    - name: Start sshd on each port with custom config
      shell: |
        /usr/sbin/sshd -f /etc/ssh/sshd_config_{{ item.port }}
      args:
        executable: /bin/bash
      loop: "{{ user_ports }}"
