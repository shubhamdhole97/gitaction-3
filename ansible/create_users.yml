---
- name: Create users and setup per-port ssh access
  hosts: all
  become: true
  vars:
    users_and_ports:
      - { name: user1, port: 2221 }
      - { name: user2, port: 2222 }
      - { name: user3, port: 2223 }
      - { name: shubham, port: 2224 }

  tasks:
    - name: Create users
      user:
        name: "{{ item.name }}"
        state: present
        shell: /bin/bash
        create_home: yes
      loop: "{{ users_and_ports }}"

    - name: Create .ssh directory
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0700'
      loop: "{{ users_and_ports }}"

    - name: Copy shared public key to authorized_keys
      copy:
        src: keys/shared.pub
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
      loop: "{{ users_and_ports }}"

    - name: Create sshd config for each user
      copy:
        dest: "/etc/ssh/sshd_config_{{ item.port }}"
        content: |
          Port {{ item.port }}
          Protocol 2
          PermitRootLogin no
          AllowUsers {{ item.name }}
          PasswordAuthentication no
          PubkeyAuthentication yes
          AuthorizedKeysFile .ssh/authorized_keys
          ChallengeResponseAuthentication no
          UsePAM yes
          AllowAgentForwarding yes
          AllowTcpForwarding yes
          X11Forwarding no
          Subsystem sftp /usr/lib/openssh/sftp-server
      loop: "{{ users_and_ports }}"

    - name: Start additional sshd instances
      systemd:
        name: sshd@{{ item.port }}
        enabled: yes
        state: started
        daemon_reload: yes
      loop: "{{ users_and_ports }}"

    - name: Create sshd@.service override (template)
      copy:
        dest: /etc/systemd/system/sshd@.service
        content: |
          [Unit]
          Description=OpenSSH per-port server for %%i
          After=network.target

          [Service]
          ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd_config_%%i
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

  handlers:
    - name: Reload systemd
      command: systemctl daemon-reexec
