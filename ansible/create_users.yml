---
- name: Minimal per-user per-port sshd (no PIDFile, no forking)
  hosts: all
  become: true
  vars:
    user_ports:
      - { name: "alice",   port: 2221 }
      - { name: "bob",     port: 2222 }
      - { name: "charlie", port: 2223 }
      - { name: "shubham", port: 2224 }

  tasks:
    - name: Ensure OpenSSH is installed and host keys exist
      apt:
        name: openssh-server
        state: present
        update_cache: yes

    - name: Generate host keys (idempotent)
      command: ssh-keygen -A
      changed_when: false

    - name: Ensure priv-sep dir exists
      file:
        path: /run/sshd
        state: directory
        owner: root
        group: root
        mode: "0755"

    # IMPORTANT: free ports from default sshd so instances can bind
    - name: Remove custom ports from default sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^Port (2221|2222|2223|2224|2225)$'
        state: absent

    - name: Ensure Port 22 exists in default
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*Port 22$'
        line: 'Port 22'
        state: present

    - name: Restart default sshd
      systemd:
        name: ssh
        state: restarted
        enabled: yes

    - name: Write minimal per-port configs (no PIDFile)
      copy:
        dest: "/etc/ssh/sshd_config_{{ item.port }}"
        mode: "0644"
        content: |
          Port {{ item.port }}
          ListenAddress 0.0.0.0
          Protocol 2
          AddressFamily any
          PermitRootLogin no
          PasswordAuthentication no
          PubkeyAuthentication yes
          AuthorizedKeysFile .ssh/authorized_keys
          ChallengeResponseAuthentication no
          UsePAM yes
          X11Forwarding no
          PrintMotd no
          ClientAliveInterval 300
          ClientAliveCountMax 2
          AllowUsers {{ item.name }}
          Include /etc/ssh/sshd_config.d/*.conf
      loop: "{{ user_ports }}"

    - name: Validate configs
      command: "sshd -t -f /etc/ssh/sshd_config_{{ item.port }}"
      loop: "{{ user_ports }}"
      changed_when: false

    - name: Install systemd template (Type=simple, no PIDFile, -D)
      copy:
        dest: /etc/systemd/system/sshd@.service
        mode: "0644"
        content: |
          [Unit]
          Description=OpenSSH per-port instance %i
          After=network.target
          Wants=network.target

          [Service]
          Type=simple
          ExecStartPre=/usr/sbin/sshd -t -f /etc/ssh/sshd_config_%i
          ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd_config_%i
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable & start per-port instances
      systemd:
        name: "sshd@{{ item.port }}"
        state: started
        enabled: yes
      loop: "{{ user_ports }}"
