---
# âœ… Ansible Playbook: create_users.yml (Updated to disable default sshd)
- name: Setup user-port restricted SSH access
  hosts: all
  become: true

  vars:
    users_and_ports:
      - { name: user1, port: 2221 }
      - { name: user2, port: 2222 }
      - { name: user3, port: 2223 }
      - { name: shubham, port: 2224 }

  tasks:
    - name: Disable default sshd on port 22
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^Port '
        state: absent
      notify: Restart SSH

    - name: Stop and disable default sshd service
      systemd:
        name: sshd
        enabled: false
        state: stopped

    - name: Create users
      user:
        name: "{{ item.name }}"
        shell: /bin/bash
        create_home: yes
      loop: "{{ users_and_ports }}"

    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0700'
      loop: "{{ users_and_ports }}"

    - name: Add shared public key to authorized_keys
      copy:
        src: keys/shared.pub
        dest: "/home/{{ item.name }}/.ssh/authorized_keys"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0600'
      loop: "{{ users_and_ports }}"

    - name: Create sshd_config for each user/port
      copy:
        dest: "/etc/ssh/sshd_config_{{ item.port }}"
        content: |
          Port {{ item.port }}
          Protocol 2
          PermitRootLogin no
          AllowUsers {{ item.name }}
          PasswordAuthentication no
          PubkeyAuthentication yes
          AuthorizedKeysFile .ssh/authorized_keys
          ChallengeResponseAuthentication no
          UsePAM yes
          AllowAgentForwarding yes
          AllowTcpForwarding yes
          X11Forwarding no
          Subsystem sftp /usr/lib/openssh/sftp-server
      loop: "{{ users_and_ports }}"

    - name: Create systemd sshd@.service template
      copy:
        dest: /etc/systemd/system/sshd@.service
        content: |
          [Unit]
          Description=Per-port OpenSSH server for %%i
          After=network.target

          [Service]
          ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd_config_%%i
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

    - name: Start sshd instance per user/port
      systemd:
        name: sshd@{{ item.port }}
        enabled: true
        state: started
      loop: "{{ users_and_ports }}"
      notify: Reload systemd

  handlers:
    - name: Reload systemd
      command: systemctl daemon-reload

    - name: Restart SSH
      service:
        name: sshd
        state: restarted
