    - name: üßæ Write SSH Keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
        chmod 644 ~/.ssh/id_rsa.pub

        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: üå± Terraform Init
      run: terraform init

    - name: üìä Terraform Plan
      run: terraform plan -var="ssh_user=${{ secrets.SSH_USER }}" -var="ssh_pub_key=${{ secrets.SSH_PUBLIC_KEY }}"

    - name: üöÄ Terraform Apply
      run: terraform apply -auto-approve -var="ssh_user=${{ secrets.SSH_USER }}" -var="ssh_pub_key=${{ secrets.SSH_PUBLIC_KEY }}"

    - name: üßæ Get Terraform Output (VM IP)
      id: tf_output
      run: |
        echo "VM_IP=$(terraform output -raw vm_ip)" >> $GITHUB_ENV

    - name: üß™ Install Ansible
      run: |
        sudo apt update && sudo apt install -y ansible

    - name: üìù Write Shared Public Key for Users
      run: |
        mkdir -p ../ansible/keys
        cp ~/.ssh/id_rsa.pub ../ansible/keys/shared.pub

    - name: üìù Update Inventory with VM IP
      run: |
        echo "Creating dynamic inventory..."
        sed "s/REPLACE_ME/${VM_IP}/" ../ansible/inventory.ini > ../ansible/inventory_dynamic.ini

    - name: ‚ñ∂Ô∏è Run Ansible: Enforce strict per-user SSH port access
      run: |
        ansible-playbook -i ../ansible/inventory_dynamic.ini ../ansible/create_users.yml
