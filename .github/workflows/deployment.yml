name: GCP VM Provisioning with Terraform & Ansible

on:
  push:
    branches: [ "main" ]

jobs:
  terraform:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: terraform

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v3

    - name: üß∞ Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: üîê Write GCP Credentials file
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > $HOME/gcp-creds.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-creds.json" >> $GITHUB_ENV

    - name: üîë Write SSH Keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
        chmod 644 ~/.ssh/id_rsa.pub

        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: üå± Terraform Init
      run: terraform init

    - name: üìä Terraform Plan
      run: terraform plan \
        -var="ssh_user=${{ secrets.SSH_USER }}" \
        -var="ssh_pub_key=${{ secrets.SSH_PUBLIC_KEY }}"

    - name: üöÄ Terraform Apply
      run: terraform apply -auto-approve \
        -var="ssh_user=${{ secrets.SSH_USER }}" \
        -var="ssh_pub_key=${{ secrets.SSH_PUBLIC_KEY }}"

    - name: üßæ Get Terraform Output (VM IP)
      id: tf_output
      run: |
        echo "VM_IP=$(terraform output -raw vm_ip)" >> $GITHUB_ENV

    # Needed to access VM on all ports via Ansible
    - name: üß™ Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible

    - name: üßæ Write Shared Public Key from Secret
      run: |
        mkdir -p ../ansible/keys
        echo "${{ secrets.SHARED_PUB_KEY }}" > ../ansible/keys/shared.pub

    - name: üìù Update Inventory with VM IP
      run: |
        echo "[servers]" > ../ansible/inventory_dynamic.ini
        echo "server1 ansible_host=${{ env.VM_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_port=22" >> ../ansible/inventory_dynamic.ini

    - name: ‚ñ∂Ô∏è Run Ansible Playbook
      run: |
        ansible-playbook -i ../ansible/inventory_dynamic.ini ../ansible/create_users.yml
